<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100-Day Burpee Challenge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <header class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">100-Day Burpee Challenge</h1>
    <p class="text-sm text-gray-600 mt-2">Any number &gt; 0 counts as completed for the day.</p>
  </header>

  <section class="max-w-7xl mx-auto px-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="summary">
    <div class="bg-white rounded-2xl shadow p-4"><div class="text-gray-500 text-xs">Participants</div><div id="cardParticipants" class="text-2xl font-bold">–</div></div>
    <div class="bg-white rounded-2xl shadow p-4"><div class="text-gray-500 text-xs">Days So Far</div><div id="cardDays" class="text-2xl font-bold">–</div></div>
    <div class="bg-white rounded-2xl shadow p-4"><div class="text-gray-500 text-xs">Total Burpees (All-Time)</div><div id="cardTotal" class="text-2xl font-bold">–</div></div>
    <div class="bg-white rounded-2xl shadow p-4"><div class="text-gray-500 text-xs">Perfect Attendance</div><div id="cardPerfect" class="text-2xl font-bold">–</div></div>
  </section>

  <!-- Progress to 100 days -->
  <section class="max-w-7xl mx-auto px-4 mt-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Challenge Progress</h2>
        <div class="text-xs text-gray-500">Days complete vs 100</div>
      </div>
      <div class="w-full bg-gray-100 rounded-xl overflow-hidden">
        <div id="progressBar" class="h-4 bg-emerald-500" style="width:0%"></div>
      </div>
      <div id="progressText" class="mt-2 text-sm text-gray-700 font-medium">0% (0 / 100 days)</div>
    </div>
  </section>

  <!-- Total burpees per day -->
  <section class="max-w-7xl mx-auto px-4 mt-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Total Burpees per Day</h2>
        <div class="text-xs text-gray-500">Bar chart (trend)</div>
      </div>
      <canvas id="burpeesChart" style="display:block;width:100%;height:280px"></canvas>
    </div>
  </section>

  <!-- Daily completion rate -->
  <section class="max-w-7xl mx-auto px-4 mt-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Daily Completion Rate</h2>
        <div class="text-xs text-gray-500">% with &gt;0 burpees each day</div>
      </div>
      <canvas id="completionChart" style="display:block;width:100%;height:280px"></canvas>
    </div>
  </section>

  <!-- Leaderboard -->
  <section class="max-w-7xl mx-auto px-4 mt-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <h3 class="text-lg font-semibold mb-2">Top Burpees (Total)</h3>
      <ol id="topTotalList" class="list-decimal list-inside text-sm space-y-1"></ol>
    </div>
  </section>

  <!-- Perfect attendance at bottom -->
  <section class="max-w-7xl mx-auto px-4 mt-6 mb-10">
    <div class="bg-white rounded-2xl shadow p-4">
      <h3 class="text-lg font-semibold mb-2">Perfect Attendance (so far)</h3>
      <p class="text-xs text-gray-500 mb-2">Alphabetical • Any value &gt; 0 counts as completed for that day</p>
      <ol id="perfectList" class="columns-1 sm:columns-2 lg:columns-3 list-decimal list-inside text-sm"></ol>
    </div>
  </section>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      SHEET_ID: "2PACX-1vRCuxbkV6GpGjHWnQIOx2YAudYpM9tCnGgDdUcw-Mp1beUXp_m4SqNkkVMqUtN4uMCHXDnKIv2e9ZTE",
      GID: "0",
      YEAR: new Date().getFullYear(),
      TIMEZONE: "Africa/Johannesburg",
    };

    // Re-init guard
    if (window.__burpeeInit) {
      console.warn("Burpee dashboard already initialised.");
    } else {
      window.__burpeeInit = true;
    }

    // ===== Dates / parsing =====
    const monthMap = {
      january:0,february:1,march:2,april:3,may:4,june:5,
      july:6,august:7,september:8,october:9,november:10,december:11,
      jan:0,feb:1,mar:2,apr:3,may2:4,jun:5,jul:6,aug:7,sep:8,sept:8,oct:9,nov:10,dec:11
    };

    function parseHeaderDate(h, assumedYear) {
      if (!h) return null;
      const t = String(h).replace(/\u00A0/g,' ').trim();
      const parts = t.split(/\s+/);
      if (parts.length < 2) return null;
      const day = parseInt(parts[0], 10);
      const monthName = parts[1].toLowerCase().replace('.', '');
      const m = monthMap[monthName];
      if (!Number.isFinite(day) || m === undefined) return null;
      const d = new Date(assumedYear, m, day);
      if (isNaN(d.getTime())) return null;
      return d;
    }
    const fmtDMo = d => d.toLocaleDateString(undefined, { day:'2-digit', month:'short' });
    const isPastOrToday = d => {
      const now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      return dd <= today;
    };

    // ===== Numbers =====
    function toNum(x) {
      if (x === null || x === undefined) return 0;
      const s = String(x).replace(/,/g,'').trim();
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    const sum = arr => arr.reduce((a,b)=>a + (toNum(b)||0), 0);

    // ===== Load sheet: CSV then HTML fallback =====
    async function fetchText(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }
    function parseCsvTextToRows(text) {
      const parsed = Papa.parse(text.trim(), { dynamicTyping: false });
      return parsed.data;
    }
    function parseHtmlTableToRows(html) {
      const doc = new DOMParser().parseFromString(html, "text/html");
      const table = doc.querySelector("table.waffle");
      if (!table) throw new Error("No table found in published HTML.");
      const rows = [];
      table.querySelectorAll("tr").forEach(tr => {
        const row = [];
        tr.querySelectorAll("th,td").forEach(td => {
          row.push(td.innerText.replace(/\u00A0/g, " ").trim());
        });
        if (row.some(c => c !== "")) rows.push(row);
      });
      return rows;
    }
    async function loadSheetRows() {
      const csvUrl  = `https://docs.google.com/spreadsheets/d/e/${CONFIG.SHEET_ID}/pub?gid=${CONFIG.GID}&single=true&output=csv&cachebust=${Date.now()}`;
      try {
        const csv = await fetchText(csvUrl);
        const rows = parseCsvTextToRows(csv);
        if (rows && rows.length && rows[0].length) return rows;
        throw new Error("CSV empty");
      } catch {
        const htmlUrl = `https://docs.google.com/spreadsheets/d/e/${CONFIG.SHEET_ID}/pubhtml?gid=${CONFIG.GID}&single=true&cachebust=${Date.now()}`;
        const html = await fetchText(htmlUrl);
        return parseHtmlTableToRows(html);
      }
    }

    // ===== Processing (clamp to 100 days) =====
    const MAX_DAYS = 100;
    function processData(rows) {
      if (!rows || rows.length === 0) throw new Error("No data");
      const headers = rows[0].map(h => String(h || "").trim());
      const nameAndDataRows = rows.slice(1).filter(r => r && r.length && String(r[0]||"").trim() !== "");

      const rawDates = headers.slice(1);
      const parsedDates = rawDates.map(h => parseHeaderDate(h, CONFIG.YEAR));

      let validIdx = [];
      for (let i = 0; i < parsedDates.length; i++) {
        const d = parsedDates[i];
        if (d && isPastOrToday(d)) validIdx.push(i);
      }
      validIdx = validIdx.slice(0, MAX_DAYS);

      const participants = [];
      const perDayTotals = Array(validIdx.length).fill(0);
      const perDayCompleters = Array(validIdx.length).fill(0);
      const perPerson = [];

      nameAndDataRows.forEach(r => {
        const name = String(r[0]).trim();
        const vals = rawDates.map((_, i) => toNum(r[i+1]));
        const valsSoFar = validIdx.map(i => vals[i]);
        const didDays = valsSoFar.map(v => v > 0);
        const totalSoFar = sum(valsSoFar);
        const perfect = didDays.length > 0 && didDays.every(Boolean);

        perPerson.push({ name, totalSoFar, perfect, didDays });
        participants.push(name);

        validIdx.forEach((i, j) => {
          perDayTotals[j] += vals[i];
          if (vals[i] > 0) perDayCompleters[j] += 1;
        });
      });

      const labels = validIdx.map(i => parsedDates[i]).map(fmtDMo);
      const participantsCount = participants.length;
      const completionRate = perDayCompleters.map(c => participantsCount ? Math.round((c/participantsCount)*100) : 0);

      return { labels, perDayTotals, completionRate, perPerson, participantsCount, daysSoFar: validIdx.length };
    }

    // ===== UI =====
    function renderSummary({participantsCount, daysSoFar, perPerson}) {
      const totalAll = perPerson.reduce((a,p)=>a+p.totalSoFar,0);
      const perfectCount = perPerson.filter(p=>p.perfect).length;
      document.getElementById('cardParticipants').textContent = participantsCount;
      document.getElementById('cardDays').textContent = daysSoFar;
      document.getElementById('cardTotal').textContent = totalAll.toLocaleString();
      document.getElementById('cardPerfect').textContent = perfectCount;

      const pct = Math.min(100, Math.max(0, Math.round((daysSoFar/100)*100)));
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressText').textContent = `${pct}% (${daysSoFar} / 100 days)`;
    }

    // Fixed-size, no-animation charts to prevent runaway growth
    let burpeesChart, completionChart;
    function renderBurpeesChart(labels, data) {
      if (burpeesChart) burpeesChart.destroy();
      burpeesChart = new Chart(document.getElementById('burpeesChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Total Burpees', data, borderWidth: 1 }] },
        options: {
          responsive: false,
          animation: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.parsed.y.toLocaleString()} burpees` } } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }
    function renderCompletionChart(labels, pct) {
      if (completionChart) completionChart.destroy();
      const safePct = pct.map(v => Number.isFinite(v) ? Math.max(0, Math.min(100, v)) : 0);
      completionChart = new Chart(document.getElementById('completionChart'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Completion %', data: safePct, tension: 0.3, fill: false }] },
        options: {
          responsive: false,
          animation: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.parsed.y}%` } } },
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
      });
    }

    function renderLeaderboards(perPerson) {
      const topTotals = [...perPerson].sort((a,b)=>b.totalSoFar - a.totalSoFar).slice(0, 15);
      document.getElementById('topTotalList').innerHTML =
        topTotals.map(p=>`<li><span class="font-medium">${p.name}</span> — ${p.totalSoFar.toLocaleString()}</li>`).join('');
      const perfect = perPerson.filter(p=>p.perfect).sort((a,b)=>a.name.localeCompare(b.name));
      document.getElementById('perfectList').innerHTML =
        perfect.length ? perfect.map(p=>`<li>${p.name}</li>`).join('') : '<li class="text-gray-500">No one (yet!)</li>';
    }

    // ===== Boot =====
    async function init() {
      try {
        const rows = await loadSheetRows();
        const ds = processData(rows);
        renderSummary(ds);
        renderBurpeesChart(ds.labels, ds.perDayTotals);
        renderCompletionChart(ds.labels, ds.completionRate);
        renderLeaderboards(ds.perPerson);
      } catch (e) {
        console.error(e);
        alert('Failed to load data. Check publish settings and header/date formats.');
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.__burpeeStarted) {
        window.__burpeeStarted = true;
        init();
      }
    });
  </script>
</body>
</html>
