<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Goals Tracker (HTML Parsing)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Arial", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Softer, pastel gradient background */
      background: linear-gradient(135deg, #d1f7ff 0%, #b3f0ff 70%, #e1ffff 100%);
      margin: 0;
      padding: 20px;
      color: black; /* Dark text for readability */
    }
    h1 {
      margin-bottom: 20px;
      /* Subtle text shadow to keep it readable, not too harsh */
      text-shadow: 1px 1px #999;
    }
    .graph-container, .debug-container {
      /* Light background to contrast with pastel body */
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      width: 90%;
      max-width: 800px;
      color: black;
    }
    canvas {
      max-width: 100%;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #f2f2f2;
      padding: 10px;
      border-radius: 5px;
      overflow: auto;
      max-height: 300px;
    }
  </style>
</head>
<body>
  <h1>Goals Tracker (HTML Parsing)</h1>
  <div class="graph-container">
    <h2>Trends</h2>
    <canvas id="sleepChart"></canvas>
    <canvas id="stretchChart"></canvas>
    <canvas id="trainingChart"></canvas>
    <canvas id="runningChart"></canvas>
  </div>

  <div class="debug-container">
    <h2>Debug Data (Raw HTML)</h2>
    <pre id="debugOutput">Loading...</pre>
  </div>

  <script>
    // Keep your existing link
    const HTML_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQg84TjR0Q-MpqqGEMaY3CSnkp5DDBpvGK-abLBMgCEfVhKIHk3Fq9rZ_U8kGDMgHxvTM-JACNtWQln/pubhtml?gid=0&single=true";

    const sleepData = [];
    const stretchData = [];
    const trainingData = [];
    const runningData = [];

    async function fetchData() {
      try {
        const response = await fetch(HTML_LINK);
        const htmlText = await response.text();

        document.getElementById("debugOutput").innerText = htmlText;

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");

        // Query all tables
        const tables = doc.querySelectorAll("table");
        if (!tables.length) {
          throw new Error("No <table> found in the fetched HTML.");
        }

        // Adjust index if needed; right now we assume the first table is your data
        const dataTable = tables[0];

        const rows = dataTable.querySelectorAll("tr");

        // Skip the header row
        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].querySelectorAll("td");
          // Ensure we have at least 5 columns
          if (cols.length < 5) continue;

          const date = cols[0].innerText.trim();
          const sleep = parseFloat(cols[1].innerText) || 0;
          const stretch = parseInt(cols[2].innerText) || 0;
          const training = parseInt(cols[3].innerText) || 0;
          const running = parseFloat(cols[4].innerText) || 0;

          if (date) {
            sleepData.push({ date, value: sleep });
            stretchData.push({ date, value: stretch });
            trainingData.push({ date, value: training });
            runningData.push({ date, value: running });
          }
        }

        updateCharts();
      } catch (error) {
        console.error("Error fetching/parsing HTML:", error);
        document.getElementById("debugOutput").innerText = `Error: ${error.message}`;
      }
    }

    function updateCharts() {
      createChart("sleepChart", sleepData, "Average Sleep", 8);
      createChart("stretchChart", stretchData, "Stretching Sessions", 5);
      createChart("trainingChart", trainingData, "Training Sessions", 6);
      createChart("runningChart", runningData, "Running Distance");
    }

    function createChart(canvasId, data, label, goal) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      const dates = data.map(entry => entry.date);
      const values = data.map(entry => entry.value);
      const goalLine = goal ? Array(values.length).fill(goal) : null;

      new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            {
              label: label,
              data: values,
              // Dark blue for the main line
              borderColor: "#003366",
              borderWidth: 2,
              fill: false
            },
            ...(goalLine
              ? [{
                  label: "Goal",
                  data: goalLine,
                  borderColor: "#777777", // Gray
                  borderWidth: 2,
                  borderDash: [5, 5],
                  fill: false
                }]
              : [])
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    fetchData();
  </script>
</body>
</html>
