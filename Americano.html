<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Padel Americano Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <style>
    body { padding: 2rem; }
    .is-pro { color:#e63946; }
    .is-intermediate { color:#ff9f1c; }
    .is-beginner { color:#2a9d8f; }
  </style>
</head>
<body>
  <section class="section">
    <h1 class="title">Padel Americano Manager</h1>
    <div class="columns">
      <div class="column is-half">
        <h2 class="subtitle">Add Player</h2>
        <div class="field">
          <label class="label">Name</label>
          <div class="control"><input id="playerName" class="input" placeholder="Player name" /></div>
        </div>
        <div class="field">
          <label class="label">Level</label>
          <div class="control">
            <div class="select">
              <select id="playerLevel">
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Pro</option>
              </select>
            </div>
          </div>
        </div>
        <button id="addBtn" class="button is-link">Add Player</button>
        <hr />
        <h2 class="subtitle">Players (<span id="playerCount">0</span>)</h2>
        <table class="table is-fullwidth" id="playerTable">
          <thead><tr><th>Name</th><th>Level</th><th>Remove</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="column is-half">
        <h2 class="subtitle">Settings</h2>
        <label class="radio"><input type="radio" name="mode" value="group"> Keep Levels Separate</label>
        <label class="radio"><input type="radio" name="mode" value="mixed" checked> Mixed Balanced</label>
        <br><br>
        <button id="scheduleBtn" class="button is-primary">Generate Schedule</button>
        <button id="resetBtn" class="button is-danger is-light">Reset All</button>
        <hr />
        <h2 class="subtitle">Leaderboard</h2>
        <table class="table is-fullwidth" id="leaderboard">
          <thead><tr><th>Player</th><th>Pts</th><th>GP</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <hr />
    <h2 class="subtitle">Matches</h2>
    <div id="matches"></div>
  </section>

<script>
/***** STORAGE *****/
let players     = JSON.parse(localStorage.getItem('players')||'[]');
let matches     = JSON.parse(localStorage.getItem('matches')||'[]');
let leaderboard = JSON.parse(localStorage.getItem('leaderboard')||'{}');
let mode        = localStorage.getItem('mode')||'mixed';
function save(){
  localStorage.setItem('players',JSON.stringify(players));
  localStorage.setItem('matches',JSON.stringify(matches));
  localStorage.setItem('leaderboard',JSON.stringify(leaderboard));
  localStorage.setItem('mode',mode);
}
/***** DOM *****/
const $tblBody = document.querySelector('#playerTable tbody');
const $count   = document.getElementById('playerCount');
const $ldBody  = document.querySelector('#leaderboard tbody');
const $matches = document.getElementById('matches');
/***** HELPERS *****/
const rank={Pro:3,Intermediate:2,Beginner:1};
function cls(l){return l==='Pro'?'is-pro':l==='Intermediate'?'is-intermediate':'is-beginner'}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
/***** RENDER *****/
function drawPlayers(){
  $tblBody.innerHTML='';
  players.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td class="${cls(p.level)}">${p.level}</td><td><button class="button is-small" onclick="delPlayer(${i})">X</button></td>`;
    $tblBody.appendChild(tr);
  });
  $count.textContent=players.length;
}
function drawLeader(){
  $ldBody.innerHTML='';
  const rows=Object.entries(leaderboard).sort((a,b)=>b[1].pts-a[1].pts);
  rows.forEach(([n,obj])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${n}</td><td>${obj.pts}</td><td>${obj.gp}</td>`;
    $ldBody.appendChild(tr);
  });
}
function drawMatches(){
  $matches.innerHTML='';
  matches.forEach((m,idx)=>{
    const box=document.createElement('div'); box.className='box';
    box.innerHTML=`<h3 class="title is-6">Round ${m.round}</h3>
    <div class="columns">
      <div class="column"><strong>${m.t1.join(' & ')}</strong><input type="number" min="0" class="input" value="${m.s1??''}" onchange="upd(${idx},'s1',this.value)"></div>
      <div class="column"><strong>${m.t2.join(' & ')}</strong><input type="number" min="0" class="input" value="${m.s2??''}" onchange="upd(${idx},'s2',this.value)"></div>
    </div>`;
    $matches.appendChild(box);
  });
}
/***** CRUD *****/
function addPlayer(){
  const name=document.getElementById('playerName').value.trim();
  if(!name)return;
  const level=document.getElementById('playerLevel').value;
  players.push({name,level});
  leaderboard[name]={pts:0,gp:0};
  document.getElementById('playerName').value='';
  save(); drawPlayers(); drawLeader();
}
function delPlayer(i){
  const n=players[i].name;
  players.splice(i,1);
  delete leaderboard[n];
  save(); drawPlayers(); drawLeader();
}
/***** SCHEDULING ALGORITHM *****/
function scheduleMixed(){
  const n=players.length; if(n<4){alert('Need at least 4');return[];}
  const plays={}; const last=-1; players.forEach(p=>plays[p.name]=0);
  const lastRnd={}; players.forEach(p=>lastRnd[p.name]=-2); // so everyone eligible round1
  let rounds=[]; let roundNo=1; let limit=n*3; // failâ€‘safe cap
  while(true){
    // sort by fewest games played, then longest waiting
    const sorted=[...players].sort((a,b)=>{
      if(plays[a.name]!==plays[b.name]) return plays[a.name]-plays[b.name];
      return lastRnd[a.name]-lastRnd[b.name];
    });
    // pick first 4 that didn't just play last round
    const pick=[]; for(const p of sorted){ if(lastRnd[p.name]<roundNo-1) {pick.push(p);} if(pick.length===4) break; }
    if(pick.length<4) break; // no more feasible rounds
    // team balance: highest+lowest vs middle pair
    pick.sort((a,b)=>rank[b.level]-rank[a.level]);
    const team1=[pick[0].name,pick[3].name];
    const team2=[pick[1].name,pick[2].name];
    rounds.push({round:roundNo,t1:team1,t2:team2,s1:null,s2:null});
    team1.concat(team2).forEach(nm=>{plays[nm]++;lastRnd[nm]=roundNo;});
    roundNo++; if(roundNo>limit)break;
    // stop when fairness reached
    const vals=Object.values(plays);
    if(Math.max(...vals)-Math.min(...vals)<=1){ // diff <=1 for everyone
      // also ensure nobody waited more than 1 last round (guaranteed by pick rule)
      const leastPlay=Math.min(...vals);
      if(vals.every(v=>v>=leastPlay+1)) break; // everyone played at least minimal cycle
    }
  }
  return rounds;
}
function buildGroups(arr){const g=[];const p=[...arr];shuffle(p);while(p.length>=4)g.push(p.splice(0,4));return g;}
function americano(g,r){const[A,B,C,D]=g;return[
 {round:r,t1:[A.name,B.name],t2:[C.name,D.name]},
 {round:r+1,t1:[A.name,C.name],t2:[B.name,D.name]},
 {round:r+2,t1:[A.name,D.name],t2:[B.name,C.name]}
];}
function scheduleGroup(){
  let r=1, out=[]; const levels={Pro:[],Intermediate:[],Beginner:[]};
  players.forEach(p=>levels[p.level].push(p));
  for(const lvl of ['Pro','Intermediate','Beginner']){
    const groups=buildGroups(levels[lvl]);
    groups.forEach(g=>{out=out.concat(americano(g,r)); r+=3;});
  }
  return out;
}
/***** MAIN *****/
function gen(){
  matches=[]; Object.values(leaderboard).forEach(o=>{o.pts=0;o.gp=0});
  mode=document.querySelector('input[name="mode"]:checked').value;
  matches= mode==='mixed'?scheduleMixed():scheduleGroup();
  if(matches.length===0){alert('Could not build matches with current settings');}
  save(); drawMatches(); drawLeader();
}
function upd(i,f,val){
  val=parseInt(val); if(isNaN(val))return; matches[i][f]=val;
  const m=matches[i]; if(m.s1!=null&&m.s2!=null){
    m.t1.forEach(n=>{leaderboard[n].pts+=m.s1; leaderboard[n].gp++;});
    m.t2.forEach(n=>{leaderboard[n].pts+=m.s2; leaderboard[n].gp++;});
  }
  save(); drawLeader();
}
function reset(){ if(!confirm('Clear all?'))return; players=[];matches=[];leaderboard={}; mode='mixed'; save(); drawPlayers(); drawLeader(); drawMatches(); }
/***** INIT *****/
document.getElementById('addBtn').onclick=addPlayer;
document.getElementById('scheduleBtn').onclick=gen;
document.getElementById('resetBtn').onclick=reset;
Array.from(document.querySelectorAll('input[name="mode"]')).forEach(r=>{r.checked=r.value===mode; r.onchange=e=>{mode=e.target.value; save();}});
drawPlayers();drawLeader();drawMatches();
</script>
</body>
</html>
