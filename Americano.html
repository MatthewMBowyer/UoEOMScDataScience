<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Padel Americano Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <style>
    body { padding: 2rem; }
    .is-pro { color:#e63946; }
    .is-intermediate { color:#ff9f1c; }
    .is-beginner { color:#2a9d8f; }
  </style>
</head>
<body>
  <section class="section">
    <h1 class="title">Padel Americano Manager</h1>
    <div class="columns">
      <!-- ░▒█ ADD PLAYER ░▒█ -->
      <div class="column is-half">
        <h2 class="subtitle">Add Player</h2>
        <div class="field">
          <label class="label">Name</label>
          <div class="control"><input id="playerName" class="input" placeholder="Player name" /></div>
        </div>
        <div class="field">
          <label class="label">Level</label>
          <div class="control">
            <div class="select">
              <select id="playerLevel">
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Pro</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <button id="addBtn" class="button is-link">Add Player</button>
        </div>
        <hr />
        <h2 class="subtitle">Players (<span id="playerCount">0</span>)</h2>
        <table class="table is-fullwidth" id="playerTable">
          <thead><tr><th>Name</th><th>Level</th><th>Remove</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- ░▒█ SETTINGS + LEADERBOARD ░▒█ -->
      <div class="column is-half">
        <h2 class="subtitle">Settings</h2>
        <div class="field">
          <label class="label">Pairing mode</label>
          <div class="control">
            <label class="radio"><input type="radio" name="mode" value="group" /> Keep Levels Separate</label>
            <label class="radio"><input type="radio" name="mode" value="mixed" checked /> Mixed Balanced</label>
          </div>
        </div>
        <div class="field">
          <button id="scheduleBtn" class="button is-primary">Generate Schedule</button>
          <button id="resetBtn" class="button is-danger is-light">Reset All</button>
        </div>
        <hr />
        <h2 class="subtitle">Leaderboard</h2>
        <table class="table is-fullwidth" id="leaderboard">
          <thead><tr><th>Player</th><th>Points</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <hr />
    <h2 class="subtitle">Matches</h2>
    <div id="matches"></div>
  </section>

<script>
/***** ░▒█  DATA & LOCAL‑STORAGE ░▒█ *****/
let players     = JSON.parse(localStorage.getItem('players')     || '[]');
let matches     = JSON.parse(localStorage.getItem('matches')     || '[]');
let leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '{}');
let mode        = localStorage.getItem('mode') || 'mixed';

function saveState(){
  localStorage.setItem('players'    , JSON.stringify(players));
  localStorage.setItem('matches'    , JSON.stringify(matches));
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
  localStorage.setItem('mode'       , mode);
}

/***** ░▒█  UI NODES ░▒█ *****/
const playerTableBody = document.querySelector('#playerTable tbody');
const playerCountSpan = document.getElementById('playerCount');
const leaderboardBody = document.querySelector('#leaderboard tbody');
const matchesDiv      = document.getElementById('matches');

/***** ░▒█  RENDER FUNCTIONS ░▒█ *****/
function classForLevel(l){ return l==='Pro' ? 'is-pro' : l==='Intermediate' ? 'is-intermediate' : 'is-beginner'; }

function renderPlayers(){
  playerTableBody.innerHTML='';
  players.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td class="${classForLevel(p.level)}">${p.level}</td><td><button class="button is-small is-danger is-light" onclick="removePlayer(${idx})">X</button></td>`;
    playerTableBody.appendChild(tr);
  });
  playerCountSpan.textContent=players.length;
}

function renderLeaderboard(){
  leaderboardBody.innerHTML='';
  Object.entries(leaderboard).sort((a,b)=>b[1]-a[1]).forEach(([n,pts])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${n}</td><td>${pts}</td>`;
    leaderboardBody.appendChild(tr);
  });
}

function renderMatches(){
  matchesDiv.innerHTML='';
  matches.forEach((m,idx)=>{
    const box=document.createElement('div');
    box.className='box';
    box.innerHTML=`<h3 class="title is-6">Round ${m.round}</h3><div class="columns"><div class="column"><p><strong>${m.team1.join(' & ')}</strong></p><input type="number" min="0" class="input" value="${m.score1??''}" onchange="updateScore(${idx},'score1',this.value)"/></div><div class="column"><p><strong>${m.team2.join(' & ')}</strong></p><input type="number" min="0" class="input" value="${m.score2??''}" onchange="updateScore(${idx},'score2',this.value)"/></div></div>`;
    matchesDiv.appendChild(box);
  });
}

/***** ░▒█  MUTATION HELPERS ░▒█ *****/
function addPlayer(){
  const name=document.getElementById('playerName').value.trim();
  const level=document.getElementById('playerLevel').value;
  if(!name) return;
  players.push({name,level});
  leaderboard[name]=leaderboard[name]||0;
  document.getElementById('playerName').value='';
  saveState();
  renderPlayers();
  renderLeaderboard();
}
function removePlayer(idx){
  const removed=players.splice(idx,1)[0];
  delete leaderboard[removed.name];
  saveState();
  renderPlayers();
  renderLeaderboard();
}

/***** ░▒█  UTILS ░▒█ *****/
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
const rankMap={Pro:3,Intermediate:2,Beginner:1};

/***** ░▒█  MIXED‑BALANCED SCHEDULER ░▒█ *****/
function generateMixedSchedule(pl){
  if(pl.length<4){alert('Need at least 4 players');return [];}  
  // clone & annotate rank
  const arr=pl.map(p=>({...p,rank:rankMap[p.level]}));
  // randomise within ranks then sort high→low (ensures Pro earliest, etc.)
  shuffle(arr);
  arr.sort((a,b)=>b.rank-a.rank);

  const queue=[...arr];
  const counts={}; arr.forEach(p=>counts[p.name]=0);
  const out=[];
  let round=1;
  const maxRounds=pl.length*2; // safety upper‑bound

  while(round<=maxRounds){
    if(queue.length<4) break;
    const current=queue.splice(0,4);
    // balance: highest+lowest vs mid‑high+mid‑low
    current.sort((a,b)=>b.rank-a.rank);
    const team1=[current[0].name,current[3].name];
    const team2=[current[1].name,current[2].name];
    out.push({round,team1,team2,score1:null,score2:null});
    current.forEach(p=>counts[p.name]++);
    queue.push(...current);
    round++;
    const vals=Object.values(counts);
    if(vals.every(v=>v>=2) && Math.max(...vals)-Math.min(...vals)<=1){
      // good balance achieved (each plays ~same, diff ≤1, min≥2)
      break;
    }
  }
  return out;
}

/***** ░▒█  GROUP (LEVEL‑SEPARATE) SCHEDULER ░▒█ *****/
function buildGroups(arr){
  const groups=[]; const pool=[...arr]; shuffle(pool);
  while(pool.length>=4){ groups.push(pool.splice(0,4)); }
  return groups;
}
function americanoThreeRound(group,startRound){
  const [A,B,C,D]=group;
  return [
    {round:startRound    ,team1:[A.name,B.name],team2:[C.name,D.name],score1:null,score2:null},
    {round:startRound + 1,team1:[A.name,C.name],team2:[B.name,D.name],score1:null,score2:null},
    {round:startRound + 2,team1:[A.name,D.name],team2:[B.name,C.name],score1:null,score2:null}
  ];
}

/***** ░▒█  MAIN SCHEDULE GENERATOR ░▒█ *****/
function generateSchedule(){
  if(players.length<4){alert('Need at least 4 players');return;}
  matches=[];
  Object.keys(leaderboard).forEach(k=>leaderboard[k]=0);

  if(mode==='mixed'){
    matches=generateMixedSchedule(players);
  } else {
    let round=1;
    const levels={Pro:[],Intermediate:[],Beginner:[]};
    players.forEach(p=>levels[p.level].push(p));
    ['Pro','Intermediate','Beginner'].forEach(lvl=>{
      const groups=buildGroups(levels[lvl]);
      groups.forEach(g=>{
        americanoThreeRound(g,round).forEach(m=>matches.push(m));
        round+=3;
      });
    });
    if(matches.length===0){alert('Not enough players of a single level to form matches.');}
  }
  saveState();
  renderMatches();
  renderLeaderboard();
}

/***** ░▒█  SCORE HANDLING ░▒█ *****/
function updateScore(idx,field,val){
  val=parseInt(val);
  if(isNaN(val)) return;
  matches[idx][field]=val;
  const m=matches[idx];
  if(m.score1!=null && m.score2!=null){
    m.team1.forEach(n=>leaderboard[n]+=m.score1);
    m.team2.forEach(n=>leaderboard[n]+=m.score2);
  }
  saveState();
  renderLeaderboard();
}

/***** ░▒█  RESET ░▒█ *****/
function resetAll(){
  if(!confirm('Clear all data?'))return;
  players=[];matches=[];leaderboard={};mode='mixed';
  saveState();
  renderPlayers();renderMatches();renderLeaderboard();
  document.querySelector('input[name="mode"][value="mixed"]').checked=true;
}

/***** ░▒█  EVENT HANDLERS ░▒█ *****/
document.getElementById('addBtn').addEventListener('click',addPlayer);
document.getElementById('scheduleBtn').addEventListener('click',generateSchedule);
document.getElementById('resetBtn').addEventListener('click',resetAll);
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.checked=(r.value===mode);
  r.addEventListener('change',e=>{mode=e.target.value;saveState();});
});

// initial UI
renderPlayers();
renderLeaderboard();
renderMatches();
</script>
</body>
</html>
