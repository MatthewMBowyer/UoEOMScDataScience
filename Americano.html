<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Padel Americano Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <style>
    body { padding: 2rem; }
    .is-pro { color:#e63946; }
    .is-intermediate { color:#ff9f1c; }
    .is-beginner { color:#2a9d8f; }
  </style>
</head>
<body>
  <section class="section">
    <h1 class="title">Padel Americano Manager</h1>
    <div class="columns">
     <div class="column is-half">
      <h2 class="subtitle">Add Player</h2>
      <div class="field">
        <label class="label">Name</label>
        <div class="control"><input id="playerName" class="input" placeholder="Player name" /></div>
      </div>
      <div class="field">
        <label class="label">Level</label>
        <div class="control">
          <div class="select">
            <select id="playerLevel">
              <option>Beginner</option>
              <option>Intermediate</option>
              <option>Pro</option>
            </select>
          </div>
        </div>
      </div>
      <div class="field">
        <button id="addBtn" class="button is-link">Add Player</button>
      </div>
      <hr />
      <h2 class="subtitle">Players (<span id="playerCount">0</span>)</h2>
      <table class="table is-fullwidth" id="playerTable">
        <thead><tr><th>Name</th><th>Level</th><th>Remove</th></tr></thead>
        <tbody></tbody>
      </table>
     </div>
     <div class="column is-half">
        <h2 class="subtitle">Settings</h2>
        <div class="field">
          <label class="label">Pairing mode</label>
          <div class="control">
            <label class="radio"><input type="radio" name="mode" value="group" /> Keep Levels Separate</label>
            <label class="radio"><input type="radio" name="mode" value="mixed" checked /> Mixed Balanced</label>
          </div>
        </div>
        <div class="field">
          <button id="scheduleBtn" class="button is-primary">Generate Schedule</button>
          <button id="resetBtn" class="button is-danger is-light">Reset All</button>
        </div>
        <hr />
        <h2 class="subtitle">Leaderboard</h2>
        <table class="table is-fullwidth" id="leaderboard">
          <thead><tr><th>Player</th><th>Points</th></tr></thead>
          <tbody></tbody>
        </table>
     </div>
    </div>
    <hr />
    <h2 class="subtitle">Matches</h2>
    <div id="matches"></div>
  </section>

<script>
// ------------------ Data & Storage ------------------
let players = JSON.parse(localStorage.getItem('players') || '[]');
let matches = JSON.parse(localStorage.getItem('matches') || '[]');
let leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '{}');
let mode = localStorage.getItem('mode') || 'mixed';

function saveState() {
  localStorage.setItem('players', JSON.stringify(players));
  localStorage.setItem('matches', JSON.stringify(matches));
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
  localStorage.setItem('mode', mode);
}

// ------------------ UI Helpers ------------------
const playerTableBody = document.querySelector('#playerTable tbody');
const playerCountSpan = document.getElementById('playerCount');
const leaderboardBody = document.querySelector('#leaderboard tbody');
const matchesDiv = document.getElementById('matches');

function renderPlayers() {
  playerTableBody.innerHTML = '';
  players.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td class="has-text-weight-semibold ${classForLevel(p.level)}">${p.level}</td>
      <td><button class="button is-small is-danger is-light" onclick="removePlayer(${idx})">X</button></td>
    `;
    playerTableBody.appendChild(tr);
  });
  playerCountSpan.textContent = players.length;
}
function classForLevel(level) {
  return level === 'Pro' ? 'is-pro' : level === 'Intermediate' ? 'is-intermediate' : 'is-beginner';
}

function renderLeaderboard() {
  leaderboardBody.innerHTML = '';
  const sorted = Object.entries(leaderboard).sort((a,b)=>b[1]-a[1]);
  sorted.forEach(([name, pts])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${pts}</td>`;
    leaderboardBody.appendChild(tr);
  });
}

function renderMatches() {
  matchesDiv.innerHTML = '';
  matches.forEach((m, idx)=>{
    const box = document.createElement('div');
    box.className = 'box';
    box.innerHTML = `
      <h3 class="title is-6">Round ${m.round}</h3>
      <div class="columns">
        <div class="column">
          <p><strong>${m.team1.join(' & ')}</strong></p>
          <input type="number" min="0" class="input" value="${m.score1 ?? ''}" onchange="updateScore(${idx}, 'score1', this.value)" />
        </div>
        <div class="column">
          <p><strong>${m.team2.join(' & ')}</strong></p>
          <input type="number" min="0" class="input" value="${m.score2 ?? ''}" onchange="updateScore(${idx}, 'score2', this.value)" />
        </div>
      </div>
    `;
    matchesDiv.appendChild(box);
  });
}

// ------------------ Core Logic ------------------
function addPlayer() {
  const name = document.getElementById('playerName').value.trim();
  const level = document.getElementById('playerLevel').value;
  if(!name) return;
  players.push({name, level});
  leaderboard[name] = leaderboard[name] || 0;
  document.getElementById('playerName').value='';
  saveState();
  renderPlayers();
  renderLeaderboard();
}

function removePlayer(idx) {
  const removed = players.splice(idx,1)[0];
  delete leaderboard[removed.name];
  saveState();
  renderPlayers();
  renderLeaderboard();
}

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} }

function generateSchedule() {
  if(players.length < 4) { alert('Need at least 4 players'); return;}
  matches=[];
  Object.keys(leaderboard).forEach(k=>leaderboard[k]=0);

  // divide into groups of 4 ensuring requested mode
  let poolPlayers = [...players];
  if(mode==='mixed'){
    poolPlayers.sort((a,b)=> levelRank(b.level)-levelRank(a.level));
  } else {
    shuffle(poolPlayers);
  }

  const groups=[];
  while(poolPlayers.length>=4){
    let group;
    if(mode==='mixed'){
      // balance group by alternating highest & lowest
      group=[ poolPlayers.shift(), poolPlayers.pop(), poolPlayers.shift(), poolPlayers.pop() ];
    } else if(mode==='group'){
      // take 4 from same level where possible, otherwise any
      const levelWanted = poolPlayers[0].level;
      group = poolPlayers.filter(p=>p.level===levelWanted).slice(0,4);
      if(group.length<4){
        group = poolPlayers.slice(0,4);
      }
      group.forEach(p=> poolPlayers.splice(poolPlayers.indexOf(p),1));
    }
    groups.push(group.filter(Boolean));
  }

  // create americano rounds within each group
  let round = 1;
  groups.forEach(group=>{
    if(group.length!==4) return; // skip incomplete
    const [A,B,C,D] = group;
    matches.push(makeMatch([A,B,C,D], round++ , [0,1,2,3])); // AB vs CD
    matches.push(makeMatch([A,B,C,D], round++ , [0,2,1,3])); // AC vs BD
    matches.push(makeMatch([A,B,C,D], round++ , [0,3,1,2])); // AD vs BC
  });

  saveState();
  renderMatches();
  renderLeaderboard();
}

function makeMatch(group, round, order){
  const g=order.map(i=>group[i]);
  return {round, team1:[g[0].name, g[1].name], team2:[g[2].name, g[3].name], score1:null, score2:null};
}
function levelRank(l){ return l==='Pro'?3 : l==='Intermediate'?2:1;}

function updateScore(idx, field, val){
  val = parseInt(val);
  if(isNaN(val)) return;
  matches[idx][field]=val;
  if(matches[idx].score1!=null && matches[idx].score2!=null){
    const {team1, team2, score1, score2}=matches[idx];
    team1.forEach(n=>leaderboard[n]+=score1);
    team2.forEach(n=>leaderboard[n]+=score2);
    matches[idx].final=true;
  }
  saveState();
  renderLeaderboard();
}

function resetAll(){
  if(!confirm('Clear all data?')) return;
  players=[]; matches=[]; leaderboard={}; mode='mixed';
  saveState();
  renderPlayers(); renderMatches(); renderLeaderboard();
  document.querySelector('input[name="mode"][value="mixed"]').checked=true;
}

// ------------------ Event Listeners ------------------
document.getElementById('addBtn').addEventListener('click', addPlayer);
document.getElementById('scheduleBtn').addEventListener('click', generateSchedule);
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.checked = (r.value===mode);
  r.addEventListener('change', e=>{ mode=e.target.value; saveState(); });
});

// initial render
renderPlayers();
renderLeaderboard();
renderMatches();
</script>
</body>
</html>
